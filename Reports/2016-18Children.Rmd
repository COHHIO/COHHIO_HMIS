---
title: "Literally Homeless Children Served in the Ohio Balance of State CoC"
author: "Coalition on Homelessness and Housing in Ohio (COHHIO)"
date: "August 13, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE
)
library(lubridate)
library(tidyverse)
library(readxl)
library(plotly)
library(janitor)
library(here)
library(gt)

```


```{r basicdatasets, echo=FALSE}
Enrollment <- read_csv(here("threeyearsdata/Enrollment.csv"),
                       col_types =                        "nnnDcnnnlnDnnnDDDnnnncccnnDnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnTTnTn")
Exit <- read_csv(here("threeyearsdata/Exit.csv"),
                 col_types = "nnnDncncnnnnnnnnnnnnnnnnnnnnnnnnnDnnnnnnTTnTn")
Project <- read_csv(here("threeyearsdata/Project.csv"),
                    col_types = "nnccDDnnnnnnnnTTnTn")
Client <- read_csv(here("threeyearsdata/Client.csv"),
                   col_types = "nccccncnDnnnnnnnnnnnnnnnnnnnnnnTTnTn")

smallEnrollment <- Enrollment %>%
  select(EnrollmentID, PersonalID, HouseholdID, EntryDate, ProjectID)
smallExit <- Exit %>%
  select(EnrollmentID, ExitDate)
smallProject <- Project %>%
  select(ProjectID, ProjectType)
smallClient <- Client %>%
  select(PersonalID, DOB)

# age calculation function

age_years <- function(earlier, later)
{
  lt <- data.frame(earlier, later)
  age <-
    as.numeric(format(lt[, 2], format = "%Y")) - as.numeric(format(lt[, 1], format =
                                                                     "%Y"))
  
  dayOnLaterYear <- ifelse(
    format(lt[, 1], format = "%m-%d") != "02-29",
    as.Date(paste(
      format(lt[, 2], format = "%Y"),
      "-",
      format(lt[, 1], format = "%m-%d"),
      sep = ""
    )),
    ifelse(
      as.numeric(format(later, format = "%Y")) %%
        400 == 0 |
        as.numeric(format(later,
                          format =
                            "%Y")) %%
        100 != 0 &
        as.numeric(format(later, format = "%Y")) %%
        4 == 0,
      as.Date(paste(
        format(lt[, 2], format = "%Y"),
        "-",
        format(lt[, 1], format =
                 "%m-%d"),
        sep = ""
      )),
      as.Date(paste(
        format(lt[, 2], format = "%Y"),
        "-",
        "02-28",
        sep = ""
      ))
    )
  )
  
  age[which(dayOnLaterYear > lt$later)] <-
    age[which(dayOnLaterYear > lt$later)] - 1
  
  age
}

```


```{r infants, echo=FALSE}
infants <-
  left_join(smallEnrollment, smallClient, by = "PersonalID") %>%
  left_join(., smallExit, by = "EnrollmentID") %>%
  left_join(., smallProject, by = "ProjectID") %>%
  mutate(
    TurnedAgeXin2016 = age_years(DOB, ymd("2016-12-31")),
    TurnedAgeXin2017 = age_years(DOB, ymd("2017-12-31")),
    TurnedAgeXin2018 = age_years(DOB, ymd("2018-12-31")),
    ServedDuring2016 = if_else(ymd(EntryDate) <= ymd("2016-12-31") &
                                 (
                                   is.na(ExitDate) | ymd(ExitDate) >= ymd("2016-01-01")
                                 ), 1, 0),
    ServedDuring2017 = if_else(ymd(EntryDate) <= ymd("2017-12-31") &
                                 (
                                   is.na(ExitDate) | ymd(ExitDate) >= ymd("2017-01-01")
                                 ), 1, 0),
    ServedDuring2018 = if_else(ymd(EntryDate) <= ymd("2018-12-31") &
                                 (
                                   is.na(ExitDate) | ymd(ExitDate) >= ymd("2018-01-01")
                                 ), 1, 0)
  ) %>%
  filter((
    ServedDuring2016 == 1 |
      ServedDuring2017 == 1 |
      ServedDuring2018 == 1
  ) &
    TurnedAgeXin2016 >= -2 & TurnedAgeXin2016 <= 0
  &
    ProjectType %in% c(1, 2, 3, 8, 9, 13)
  ) %>%
  select(
    PersonalID,
    DOB,
    ProjectType,
    TurnedAgeXin2016,
    TurnedAgeXin2017,
    TurnedAgeXin2018,
    ServedDuring2016,
    ServedDuring2017,
    ServedDuring2018
  )

infantplot <- infants %>%
  mutate(
    school2016 = if_else(ServedDuring2016 == 1 &
                           TurnedAgeXin2016 == 0,
                         1,
                         0),
    school2017 = if_else(ServedDuring2017 == 1 &
                           TurnedAgeXin2017 == 0,
                         1,
                         0),
    school2018 = if_else(ServedDuring2018 == 1 &
                           TurnedAgeXin2018 == 0,
                         1,
                         0)
  ) %>%
  select(PersonalID, school2016, school2017, school2018) %>%
  gather(key = "year", value = "infants",-PersonalID) %>%
  filter(infants == 1) %>%
  mutate(year = str_extract(year, "[0-9]+")) %>%
  group_by(year) %>%
  summarise(infants = sum(infants))


```


```{r preschool, echo=FALSE}
preschool <-
  left_join(smallEnrollment, smallClient, by = "PersonalID") %>%
  left_join(., smallExit, by = "EnrollmentID") %>%
  left_join(., smallProject, by = "ProjectID") %>%
  mutate(
    TurnedAgeXin2016 = age_years(DOB, ymd("2016-12-31")),
    TurnedAgeXin2017 = age_years(DOB, ymd("2017-12-31")),
    TurnedAgeXin2018 = age_years(DOB, ymd("2018-12-31")),
    ServedDuring2016 = if_else(ymd(EntryDate) <= ymd("2016-12-31") &
                                 (
                                   is.na(ExitDate) | ymd(ExitDate) >= ymd("2016-01-01")
                                 ), 1, 0),
    ServedDuring2017 = if_else(ymd(EntryDate) <= ymd("2017-12-31") &
                                 (
                                   is.na(ExitDate) | ymd(ExitDate) >= ymd("2017-01-01")
                                 ), 1, 0),
    ServedDuring2018 = if_else(ymd(EntryDate) <= ymd("2018-12-31") &
                                 (
                                   is.na(ExitDate) | ymd(ExitDate) >= ymd("2018-01-01")
                                 ), 1, 0)
  ) %>%
  filter((
    ServedDuring2016 == 1 |
      ServedDuring2017 == 1 |
      ServedDuring2018 == 1
  ) &
    TurnedAgeXin2016 >= -1 & TurnedAgeXin2016 <= 5
  &
    ProjectType %in% c(1, 2, 3, 8, 9, 13)
  ) %>%
  select(
    PersonalID,
    DOB,
    ProjectType,
    TurnedAgeXin2016,
    TurnedAgeXin2017,
    TurnedAgeXin2018,
    ServedDuring2016,
    ServedDuring2017,
    ServedDuring2018
  )

preschoolplot <- preschool %>%
  mutate(
    school2016 = if_else(
      ServedDuring2016 == 1 &
        TurnedAgeXin2016 >= 1 &
        TurnedAgeXin2016 < 6,
      1,
      0
    ),
    school2017 = if_else(
      ServedDuring2017 == 1 &
        TurnedAgeXin2017 >= 1 &
        TurnedAgeXin2017 < 6,
      1,
      0
    ),
    school2018 = if_else(
      ServedDuring2018 == 1 &
        TurnedAgeXin2018 >= 1 &
        TurnedAgeXin2018 < 6,
      1,
      0
    )
  ) %>%
  select(PersonalID, school2016, school2017, school2018) %>%
  gather(key = "year", value = "preschoolers",-PersonalID) %>%
  filter(preschoolers == 1) %>%
  mutate(year = str_extract(year, "[0-9]+")) %>%
  group_by(year) %>%
  summarise(preschoolers = sum(preschoolers))

```


```{r school, echo=FALSE}
school_age <-
  left_join(smallEnrollment, smallClient, by = "PersonalID") %>%
  left_join(., smallExit, by = "EnrollmentID") %>%
  left_join(., smallProject, by = "ProjectID") %>%
  mutate(
    TurnedAgeXin2016 = age_years(DOB, ymd("2016-12-31")),
    TurnedAgeXin2017 = age_years(DOB, ymd("2017-12-31")),
    TurnedAgeXin2018 = age_years(DOB, ymd("2018-12-31")),
    ServedDuring2016 = if_else(ymd(EntryDate) <= ymd("2016-12-31") &
                                 (
                                   is.na(ExitDate) | ymd(ExitDate) >= ymd("2016-01-01")
                                 ), 1, 0),
    ServedDuring2017 = if_else(ymd(EntryDate) <= ymd("2017-12-31") &
                                 (
                                   is.na(ExitDate) | ymd(ExitDate) >= ymd("2017-01-01")
                                 ), 1, 0),
    ServedDuring2018 = if_else(ymd(EntryDate) <= ymd("2018-12-31") &
                                 (
                                   is.na(ExitDate) | ymd(ExitDate) >= ymd("2018-01-01")
                                 ), 1, 0)
  ) %>%
  filter((
    ServedDuring2016 == 1 |
      ServedDuring2017 == 1 |
      ServedDuring2018 == 1
  ) &
    TurnedAgeXin2016 >= 4 & TurnedAgeXin2016 <= 17
  &
    ProjectType %in% c(1, 2, 3, 8, 9, 13)
  ) %>%
  select(
    PersonalID,
    DOB,
    ProjectType,
    TurnedAgeXin2016,
    TurnedAgeXin2017,
    TurnedAgeXin2018,
    ServedDuring2016,
    ServedDuring2017,
    ServedDuring2018
  )

schoolplot <- school_age %>%
  mutate(
    school2016 = if_else(
      ServedDuring2016 == 1 &
        TurnedAgeXin2016 > 5 &
        TurnedAgeXin2016 < 18,
      1,
      0
    ),
    school2017 = if_else(
      ServedDuring2017 == 1 &
        TurnedAgeXin2017 > 5 &
        TurnedAgeXin2017 < 18,
      1,
      0
    ),
    school2018 = if_else(
      ServedDuring2018 == 1 &
        TurnedAgeXin2018 > 5 &
        TurnedAgeXin2018 < 18,
      1,
      0
    )
  ) %>%
  select(PersonalID, school2016, school2017, school2018) %>%
  gather(key = "year", value = "school_age",-PersonalID) %>%
  filter(school_age == 1) %>%
  mutate(year = str_extract(year, "[0-9]+")) %>%
  group_by(year) %>%
  summarise(school_age = sum(school_age))

```

## Households in Emergency Shelter or Transitional Housing with Children

```{r hhsplot, echo=FALSE}
hhs <-
  left_join(smallEnrollment, smallClient, by = "PersonalID") %>%
  left_join(., smallExit, by = "EnrollmentID") %>%
  left_join(., smallProject, by = "ProjectID") %>%
  mutate(
    TurnedAgeXin2016 = age_years(DOB, ymd("2016-12-31")),
    TurnedAgeXin2017 = age_years(DOB, ymd("2017-12-31")),
    TurnedAgeXin2018 = age_years(DOB, ymd("2018-12-31")),
    ServedDuring2016 = if_else(ymd(EntryDate) <= ymd("2016-12-31") &
                                 (
                                   is.na(ExitDate) | ymd(ExitDate) >= ymd("2016-01-01")
                                 ), 1, 0),
    ServedDuring2017 = if_else(ymd(EntryDate) <= ymd("2017-12-31") &
                                 (
                                   is.na(ExitDate) | ymd(ExitDate) >= ymd("2017-01-01")
                                 ), 1, 0),
    ServedDuring2018 = if_else(ymd(EntryDate) <= ymd("2018-12-31") &
                                 (
                                   is.na(ExitDate) | ymd(ExitDate) >= ymd("2018-01-01")
                                 ), 1, 0)
  ) %>%
  filter((
    ServedDuring2016 == 1 |
      ServedDuring2017 == 1 |
      ServedDuring2018 == 1
  ) &
    TurnedAgeXin2016 >= -2 & 
    TurnedAgeXin2016 <= 18
  &
    ProjectType %in% c(1, 2, 3, 8, 9, 13)
  ) %>%
  select(
    PersonalID,
    DOB,
    ProjectType,
    HouseholdID,
    EntryDate,
    ExitDate,
    TurnedAgeXin2016,
    TurnedAgeXin2017,
    TurnedAgeXin2018,
    ServedDuring2016,
    ServedDuring2017,
    ServedDuring2018
  )

ph_hhs <- hhs %>%
  filter(ProjectType %in% c(3, 9, 13))

hhplot <- hhs %>%
  mutate(
    child2016 = if_else(
      ServedDuring2016 == 1 &
        TurnedAgeXin2016 >= 0 &
        TurnedAgeXin2016 <= 18,
      1,
      0
    ),
    child2017 = if_else(
      ServedDuring2017 == 1 &
        TurnedAgeXin2017 >= 0 &
        TurnedAgeXin2017 <= 18,
      1,
      0
    ),
    child2018 = if_else(
      ServedDuring2018 == 1 &
        TurnedAgeXin2018 >= 0 &
        TurnedAgeXin2018 <= 18,
      1,
      0
    )
  ) %>%
  select(child2016, child2017, child2018, HouseholdID) %>%
  filter(child2016 + child2017 + child2018 > 0) %>%
  group_by(HouseholdID) %>%
  summarise(
    child2016 = max(child2016),
    child2017 = max(child2017),
    child2018 = max(child2018)
  ) %>%
  gather(key = "year", value = "households", -HouseholdID) %>%
  filter(households == 1) %>%
  mutate(year = str_extract(year, "[0-9]+")) %>%
  group_by(year) %>%
  summarise(households = sum(households))

ph_hhplot <- ph_hhs %>%
  mutate(
    child2016 = if_else(
      ServedDuring2016 == 1 &
        TurnedAgeXin2016 >= 0 &
        TurnedAgeXin2016 <= 18,
      1,
      0
    ),
    child2017 = if_else(
      ServedDuring2017 == 1 &
        TurnedAgeXin2017 >= 0 &
        TurnedAgeXin2017 <= 18,
      1,
      0
    ),
    child2018 = if_else(
      ServedDuring2018 == 1 &
        TurnedAgeXin2018 >= 0 &
        TurnedAgeXin2018 <= 18,
      1,
      0
    )
  ) %>%
  select(child2016, child2017, child2018, HouseholdID) %>%
  filter(child2016 + child2017 + child2018 > 0) %>%
  group_by(HouseholdID) %>%
  summarise(
    child2016 = max(child2016),
    child2017 = max(child2017),
    child2018 = max(child2018)
  ) %>%
  gather(key = "year", value = "households", -HouseholdID) %>%
  filter(households == 1) %>%
  mutate(year = str_extract(year, "[0-9]+")) %>%
  group_by(year) %>%
  summarise(households = sum(households))

plot_ly(
  hhplot,
  x = ~ hhplot$year,
  y = ~ hhplot$households,
  name = "Served in Any Project",
  type = "scatter",
  mode = "none",
  fill = "tozeroy",
  line = list(color = "rgb(0, 0, 85)"),
  hoverinfo = 'y',
  fillcolor = "rgb(0, 0, 96)"
) %>%
  add_trace(ph_hhplot,
            name = "Housed in RRH or PSH",
            x = ~ ph_hhplot$year,
            y = ~ ph_hhplot$households,
            mode = "lines",
            fill = "tozeroy",
            line = list(color = "rgb(85, 0, 85)"),
            fillcolor = "rgba(96, 0, 96, .8)") %>%
  layout(
    title = "Households with Children in Any Homeless Program",
    xaxis = list(title = "Year"),
    yaxis = list(title = "Households Served"),
    margin = list(pad = 22, r = 60))
  
```


## Individual Children Served {.tabset .tabset-fade}
Homeless children served 2016 - 2018 in 80 rural and suburban counties in Ohio

### All
```{r all, echo=FALSE}

plotstaging <- full_join(infantplot, preschoolplot, by = "year") %>%
  full_join(schoolplot, by = "year")

plot_ly(
  plotstaging,
  x = ~ year,
  y = ~ infants,
  name = "Less than 1 year old",
  hoverinfo = 'y',
  type = "bar"
) %>%
  add_trace(y = ~ preschoolers, name = "Ages 1 to 5") %>%
  add_trace(y = ~ school_age, name = "Ages 6 to 17") %>%
  layout(
    title = "Homeless Children Served in Any Homeless Program",
    xaxis = list(title = "Year"),
    yaxis = list(title = "Children Served"),
    barmode = "stack"
  )
```

### Literally Homeless (Not Including Unsheltered)

```{r lh, echo=FALSE}
lh_infantplot <- infants %>%
  filter(ProjectType %in% c(1, 2, 8)) %>%
  mutate(
    school2016 = if_else(ServedDuring2016 == 1 &
                           TurnedAgeXin2016 == 0,
                         1,
                         0),
    school2017 = if_else(ServedDuring2017 == 1 &
                           TurnedAgeXin2017 == 0,
                         1,
                         0),
    school2018 = if_else(ServedDuring2018 == 1 &
                           TurnedAgeXin2018 == 0,
                         1,
                         0)
  ) %>%
  select(PersonalID, school2016, school2017, school2018) %>%
  gather(key = "year", value = "infants",-PersonalID) %>%
  filter(infants == 1) %>%
  mutate(year = str_extract(year, "[0-9]+")) %>%
  group_by(year) %>%
  summarise(infants = sum(infants))

lh_preschoolplot <- preschool %>%
  filter(ProjectType %in% c(1, 2, 8)) %>%
  mutate(
    school2016 = if_else(
      ServedDuring2016 == 1 &
        TurnedAgeXin2016 >= 1 &
        TurnedAgeXin2016 < 6,
      1,
      0
    ),
    school2017 = if_else(
      ServedDuring2017 == 1 &
        TurnedAgeXin2017 >= 1 &
        TurnedAgeXin2017 < 6,
      1,
      0
    ),
    school2018 = if_else(
      ServedDuring2018 == 1 &
        TurnedAgeXin2018 >= 1 &
        TurnedAgeXin2018 < 6,
      1,
      0
    )
  ) %>%
  select(PersonalID, school2016, school2017, school2018) %>%
  gather(key = "year", value = "preschoolers",-PersonalID) %>%
  filter(preschoolers == 1) %>%
  mutate(year = str_extract(year, "[0-9]+")) %>%
  group_by(year) %>%
  summarise(preschoolers = sum(preschoolers))

lh_schoolplot <- school_age %>%
  filter(ProjectType %in% c(1, 2, 8)) %>%
  mutate(
    school2016 = if_else(
      ServedDuring2016 == 1 &
        TurnedAgeXin2016 > 5 &
        TurnedAgeXin2016 < 18,
      1,
      0
    ),
    school2017 = if_else(
      ServedDuring2017 == 1 &
        TurnedAgeXin2017 > 5 &
        TurnedAgeXin2017 < 18,
      1,
      0
    ),
    school2018 = if_else(
      ServedDuring2018 == 1 &
        TurnedAgeXin2018 > 5 &
        TurnedAgeXin2018 < 18,
      1,
      0
    )
  ) %>%
  select(PersonalID, school2016, school2017, school2018) %>%
  gather(key = "year", value = "school_age",-PersonalID) %>%
  filter(school_age == 1) %>%
  mutate(year = str_extract(year, "[0-9]+")) %>%
  group_by(year) %>%
  summarise(school_age = sum(school_age))

lh_plotstaging <-
  full_join(lh_infantplot, lh_preschoolplot, by = "year") %>%
  full_join(lh_schoolplot, by = "year")

plot_ly(
  lh_plotstaging,
  x = ~ year,
  y = ~ infants,
  name = "Less than 1 year old",
  hoverinfo = 'y',
  type = "bar"
) %>%
  add_trace(y = ~ preschoolers, name = "Ages 1 to 5") %>%
  add_trace(y = ~ school_age, name = "Ages 6 to 17") %>%
  layout(
    title = "Children in Emergency Shelters",
    xaxis = list(title = "Year"),
    yaxis = list(title = "Children Served"),
    barmode = "stack"
  )

```

### Housed in RRH or PSH

```{r ph, echo=FALSE}
ph_infantplot <- infants %>%
  filter(ProjectType %in% c(3, 9, 13)) %>%
  mutate(
    school2016 = if_else(ServedDuring2016 == 1 &
                           TurnedAgeXin2016 == 0,
                         1,
                         0),
    school2017 = if_else(ServedDuring2017 == 1 &
                           TurnedAgeXin2017 == 0,
                         1,
                         0),
    school2018 = if_else(ServedDuring2018 == 1 &
                           TurnedAgeXin2018 == 0,
                         1,
                         0)
  ) %>%
  select(PersonalID, school2016, school2017, school2018) %>%
  gather(key = "year", value = "infants",-PersonalID) %>%
  filter(infants == 1) %>%
  mutate(year = str_extract(year, "[0-9]+")) %>%
  group_by(year) %>%
  summarise(infants = sum(infants))

ph_preschoolplot <- preschool %>%
  filter(ProjectType %in% c(3, 9, 13)) %>%
  mutate(
    school2016 = if_else(
      ServedDuring2016 == 1 &
        TurnedAgeXin2016 >= 1 &
        TurnedAgeXin2016 < 6,
      1,
      0
    ),
    school2017 = if_else(
      ServedDuring2017 == 1 &
        TurnedAgeXin2017 >= 1 &
        TurnedAgeXin2017 < 6,
      1,
      0
    ),
    school2018 = if_else(
      ServedDuring2018 == 1 &
        TurnedAgeXin2018 >= 1 &
        TurnedAgeXin2018 < 6,
      1,
      0
    )
  ) %>%
  select(PersonalID, school2016, school2017, school2018) %>%
  gather(key = "year", value = "preschoolers",-PersonalID) %>%
  filter(preschoolers == 1) %>%
  mutate(year = str_extract(year, "[0-9]+")) %>%
  group_by(year) %>%
  summarise(preschoolers = sum(preschoolers))

ph_schoolplot <- school_age %>%
  filter(ProjectType %in% c(3, 9, 13)) %>%
  mutate(
    school2016 = if_else(
      ServedDuring2016 == 1 &
        TurnedAgeXin2016 > 5 &
        TurnedAgeXin2016 < 18,
      1,
      0
    ),
    school2017 = if_else(
      ServedDuring2017 == 1 &
        TurnedAgeXin2017 > 5 &
        TurnedAgeXin2017 < 18,
      1,
      0
    ),
    school2018 = if_else(
      ServedDuring2018 == 1 &
        TurnedAgeXin2018 > 5 &
        TurnedAgeXin2018 < 18,
      1,
      0
    )
  ) %>%
  select(PersonalID, school2016, school2017, school2018) %>%
  gather(key = "year", value = "school_age",-PersonalID) %>%
  filter(school_age == 1) %>%
  mutate(year = str_extract(year, "[0-9]+")) %>%
  group_by(year) %>%
  summarise(school_age = sum(school_age))

ph_plotstaging <-
  full_join(ph_infantplot, ph_preschoolplot, by = "year") %>%
  full_join(ph_schoolplot, by = "year")

plot_ly(
  ph_plotstaging,
  x = ~ year,
  y = ~ infants,
  name = "Less than 1 year old",
  hoverinfo = 'y',
  type = "bar"
) %>%
  add_trace(y = ~ preschoolers, name = "Ages 1 to 5") %>%
  add_trace(y = ~ school_age, name = "Ages 6 to 17") %>%
  layout(
    title = "Children Housed in Rapid Rehousing or Permanent Supportive Housing",
    xaxis = list(title = "Year"),
    yaxis = list(title = "Children Served"),
    barmode = "stack"
  )

```

<!-- ## Number of Children Served in the Ohio Balance of State in 2018 -->

<!-- ![](/Users\HMIS1\Documents\R\COHHIO_HMIS\data\state.png)  -->

## Top 20 Counties Serving Children in 2018

```{r counties, echo=FALSE}
counties <- read_xlsx(here("data/RMisc.xlsx"),
                      sheet = 2,
                      range = cell_cols("A:B"))

regions <- read_csv(here("data/Regions.csv"), col_types = "cd") 

counties2018 <- left_join(smallEnrollment, smallClient, by = "PersonalID") %>%
  left_join(., smallExit, by = "EnrollmentID") %>%
  left_join(., smallProject, by = "ProjectID") %>%  
  left_join(counties, by = "EnrollmentID") %>%
  mutate(CountyServed = if_else(CountyServed == "Van Wert", "Vanwert", CountyServed)) %>%
  left_join(regions, by = c("CountyServed" = "County")) %>%
  filter(ProjectType %in% c(1, 2, 3, 8, 9, 13)) %>%
  mutate(age = age_years(DOB, ymd("2018-12-31")),
         servedIn2018 = if_else(ymd(EntryDate) <= ymd("2018-12-31") &
                                  (
                                    is.na(ExitDate) |
                                      ymd(ExitDate) >= ymd("2018-01-01")
                                  ), 1, 0),
         CountyServed = if_else(CountyServed == "Vanwert", "Van Wert", CountyServed)) %>%
  filter(age <= 18, servedIn2018 == 1)

childs <- counties2018 %>%
  group_by(CountyServed, Region) %>%
  summarise(individuals = n()) %>%
  ungroup()

households <- counties2018 %>%
  select(HouseholdID, CountyServed, Region) %>%
  unique() %>% 
  group_by(CountyServed, Region) %>%
  summarise(households = n()) %>%
  ungroup()

countylist <- full_join(childs, households, by = c("Region", "CountyServed")) %>%
  mutate(Children = paste(individuals, "children in", households, "households"),
         County = CountyServed) %>%
  arrange(desc(individuals)) %>%
  select(County, Children) 

gt(head(countylist, n = 20L))

```

## Homeless Planning Regions (Served in 2018)

```{r regionlist, echo=FALSE}

region_childs <- counties2018 %>%
  group_by(Region) %>%
  summarise(individuals = n()) %>%
  ungroup()

region_households <- counties2018 %>%
  select(HouseholdID, Region) %>%
  unique() %>% 
  group_by(Region) %>%
  summarise(households = n()) %>%
  ungroup()

regionlist <-
  full_join(region_childs,
            region_households,
            by = "Region") %>%
  filter(!is.na(Region)) %>%
  mutate(
    Children = paste(individuals, "children in", households, "households"),
    Region = paste("Homeless Planning Region", Region)
  ) %>%
  arrange(desc(individuals)) %>%
  select(Region, Children) 

gt(regionlist)

```



