---
title: "COVID-19 in Ohio BoS CoC Populations"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(lubridate)
library(knitr)
library(here)

if(exists("dataset") == FALSE) {
  dataset <- "live"
} else {
  dataset <- dataset
}

directory <- case_when(dataset == "live" ~ "data",
                       dataset == "sample" ~ "sampledata",
                       dataset == "yo" ~ "youngstowndata")

if(file.exists(here(paste0(directory, "/covid19.zip")))) {
  unzip(zipfile = here(paste0("./", directory, "/covid19.zip")), 
        exdir = here(paste0("./", directory)))
  
  file.rename(here(paste0(directory, "/", list.files(here(paste0("./", directory)), 
                                                pattern = "(report_)"))),
              here(paste0(directory, "/covid19.csv")))
  
  file.remove(here(paste0(directory, "/covid19.zip")))
}

covid19 <- read_csv(here(paste0(directory, "/covid19.csv")),
                    col_types = "ncccccccccccccccccccccccc") %>%
  mutate(
    COVID19AssessmentDate = mdy(COVID19AssessmentDate),
    ContactWithConfirmedDate = mdy(ContactWithConfirmedDate),
    ContactWithUnderInvestigationDate = mdy(ContactWithUnderInvestigationDate),
    TestDate = mdy(TestDate),
    DateUnderInvestigation = mdy(DateUnderInvestigation)
  ) %>%
  filter(ymd(COVID19AssessmentDate) > ymd("20200401"))
```

## What Data We're Collecting

The Ohio Balance of State CoC is collecting COVID-19 data based on the CDC's guidelines, listed [here](https://www.cdc.gov/coronavirus/2019-ncov/symptoms-testing/symptoms.html). We began collecting this data in April 2020.

Please send inquiries to hmis@cohhio.org.

## COVID-19 Status of Clients Over Time

```{r symptoms}

basic <- covid19 %>%
  as_tibble() %>%
  mutate(
    Symptom1BreathingDifficult = case_when(
      is.na(Symptom1BreathingDifficult) |
        Symptom1BreathingDifficult == "No" ~ 0,
      Symptom1BreathingDifficult == "Yes" ~ 1),
    Symptom1Cough = case_when(
      is.na(Symptom1Cough) |
        Symptom1Cough == "No" ~ 0,
      Symptom1Cough == "Yes" ~ 1),
    Symptom2Chills = case_when(
      is.na(Symptom2Chills) |
        Symptom2Chills == "No" ~ 0,
      Symptom2Chills == "Yes" ~ 1),
    Symptom2Fever = case_when(
      is.na(Symptom2Fever) |
        Symptom2Fever == "No" ~ 0,
      Symptom2Fever == "Yes" ~ 1),
    Symptom2Headache = case_when(
      is.na(Symptom2Headache) |
        Symptom2Headache == "No" ~ 0,
      Symptom2Headache == "Yes" ~ 1),
    Symptom2LostTasteSmell = case_when(
      is.na(Symptom2LostTasteSmell) |
        Symptom2LostTasteSmell == "No" ~ 0,
      Symptom2LostTasteSmell == "Yes" ~ 1),
    Symptom2MusclePain = case_when(
      is.na(Symptom2MusclePain) |
        Symptom2MusclePain == "No" ~ 0,
      Symptom2MusclePain == "Yes" ~ 1),
    Symptom2ShakingChills = case_when(
      is.na(Symptom2ShakingChills) |
        Symptom2ShakingChills == "No" ~ 0,
      Symptom2ShakingChills == "Yes" ~ 1),
    Symptom2SoreThroat = case_when(
      is.na(Symptom2SoreThroat) |
        Symptom2SoreThroat == "No" ~ 0,
      Symptom2SoreThroat == "Yes" ~ 1),
    HealthRiskChronicIllness = case_when(
      is.na(HealthRiskChronicIllness) |
        HealthRiskChronicIllness == "No" ~ 0,
      HealthRiskChronicIllness == "Yes" ~ 1),
    HealthRiskHistoryOfRespiratoryIllness = case_when(
      is.na(HealthRiskHistoryOfRespiratoryIllness) |
        HealthRiskHistoryOfRespiratoryIllness == "No" ~ 0,
      HealthRiskHistoryOfRespiratoryIllness == "Yes" ~ 1),
    HealthRiskOver60 = case_when(
      is.na(HealthRiskOver60) |
        HealthRiskOver60 == "No" ~ 0,
      HealthRiskOver60 == "Yes" ~ 1),
    ContactWithConfirmedCOVID19Patient = case_when(
      is.na(ContactWithConfirmedCOVID19Patient) |
        ContactWithConfirmedCOVID19Patient == "No" ~ 0,
      ContactWithConfirmedCOVID19Patient == "Yes" ~ 1),
    ContactWithUnderCOVID19Investigation = case_when(
      is.na(ContactWithUnderCOVID19Investigation) |
        ContactWithUnderCOVID19Investigation == "No" ~ 0,
      ContactWithUnderCOVID19Investigation == "Yes" ~ 1),
    Tested = case_when(
      is.na(Tested) |
        Tested == "No" ~ 0,
      Tested == "Yes" ~ 1),
    UnderInvestigation = case_when(
      is.na(UnderInvestigation) |
        UnderInvestigation == "No" ~ 0,
      UnderInvestigation == "Yes" ~ 1))

CDCsymptomatic <- basic %>%
  mutate(
    MayHaveCOVID19CDC = (
      COVID19AssessmentDate > today() - days(14) &
        (Symptom1BreathingDifficult == 1 |
           Symptom1Cough == 1)
    ) |
      (
        ContactWithConfirmedCOVID19Patient == 1 &
          (ymd(ContactWithConfirmedDate) > today() - days(14) |
          is.na(ContactWithConfirmedDate))
      ) |
      (
        ContactWithUnderCOVID19Investigation == 1 &
          (ymd(ContactWithUnderInvestigationDate) > today() - days(14) |
          is.na(ContactWithUnderInvestigationDate))
      ) |
      (
        COVID19AssessmentDate > today() - days(14) &
          Symptom2Chills + Symptom2SoreThroat + Symptom2Fever +
          Symptom2Headache + Symptom2LostTasteSmell + Symptom2MusclePain +
          Symptom2ShakingChills > 1
      )
  ) %>%
  group_by(MayHaveCOVID19CDC) %>%
  summarise(Clients = n())

```

Since April 1, **`r nrow(basic)`** clients have been screened for COVID-19. "No Current Indications" means the client does not have symptoms that would indicate they have COVID-19 and they have not tested positive. "May Have COVID-19" means the client has not tested positive for COVID-19 but is defined in the [CDC's guidelines](https://www.cdc.gov/coronavirus/2019-ncov/symptoms-testing/symptoms.html) as either having at least one Primary Symptom or at least 2 Secondary Symptoms or has had contact with a person who is confirmed to have or is under investigation for COVID-19. "Positive" means the client has self-reported that they were tested for COVID-19 by a medical professional and the test was positive.

```{r fig1, fig.width=7, fig.asp=.62}
# since this is meant to show the state of clients over time and at the point of their most recent assessment, this logic is a little different from the logic for the Prioritization report in that we are throwing out time-dependent data based on the AssessmentDate, not based on its distance from "today".

plot_a <- basic %>%
  mutate(
    COVID19Status = case_when(
      Tested == 1 & TestResults == "Positive" &
        ymd(TestDate) > ymd(COVID19AssessmentDate) - days(14) &
        !is.na(TestDate) ~ "Positive",
      (Symptom1BreathingDifficult == 1 |
         Symptom1Cough == 1)
      |
        (
          ContactWithConfirmedCOVID19Patient == 1 &
            (
              ymd(ContactWithConfirmedDate) >
                ymd(COVID19AssessmentDate) - days(14) |
                is.na(ContactWithConfirmedDate)
            )
        ) |
        (
          ContactWithUnderCOVID19Investigation == 1 &
            (
              ymd(ContactWithUnderInvestigationDate) >
                ymd(COVID19AssessmentDate) - days(14) |
                is.na(ContactWithUnderInvestigationDate)
            )
        ) |
        (
          Symptom2Chills + Symptom2SoreThroat + Symptom2Fever +
            Symptom2Headache + Symptom2LostTasteSmell + Symptom2MusclePain +
            Symptom2ShakingChills > 1
        ) |
        (
          UnderInvestigation == 1 &
            ymd(DateUnderInvestigation) > ymd(COVID19AssessmentDate) - days(14)
        ) ~
        "May Have COVID-19",
      
      TRUE ~ "No Current Indications"
    ),
    COVID19Status = factor(
      COVID19Status,
      levels = c("No Current Indications",
                 "May Have COVID-19",
                 "Positive")
    )
  )

plot_a %>%
  select(PersonalID, COVID19AssessmentDate, COVID19Status) %>%
  group_by(COVID19AssessmentDate, COVID19Status) %>%
  summarise(Clients = n()) %>%
  ggplot(aes(x = COVID19AssessmentDate, y = Clients,
             fill = COVID19Status)) +
  geom_bar(stat = "identity", 
           position = position_stack(reverse = TRUE)) +  
  scale_fill_brewer(palette = "Dark2") +
  theme_classic() +
  ggtitle("Clients COVID-19 Assessments in the Ohio Balance of State CoC") +
  labs(x = "Date of Assessment", y = "Clients Assessed") +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.key.height = unit(0.1, "cm"),
        legend.key.width = unit(0.3, "cm"))

```

\pagebreak

## Priority for Immediate Non-congregate Housing

```{r risks, echo=FALSE}

risks <- basic %>%
  mutate(
    MayHaveCOVID19CDC = (
      COVID19AssessmentDate > today() - days(14) &
        (Symptom1BreathingDifficult == 1 |
           Symptom1Cough == 1)
    ) |
      (
        ContactWithConfirmedCOVID19Patient == 1 &
          (ymd(ContactWithConfirmedDate) > today() - days(14) |
          is.na(ContactWithConfirmedDate))
      ) |
      (
        ContactWithUnderCOVID19Investigation == 1 &
          (ymd(ContactWithUnderInvestigationDate) > today() - days(14) |
          is.na(ContactWithUnderInvestigationDate))
      ) |
      (
        COVID19AssessmentDate > today() - days(14) &
          Symptom2Chills + Symptom2SoreThroat + Symptom2Fever +
          Symptom2Headache + Symptom2LostTasteSmell + Symptom2MusclePain +
          Symptom2ShakingChills > 1
      ),
    HealthRisks = HealthRiskOver60 +
      HealthRiskHistoryOfRespiratoryIllness +
      HealthRiskChronicIllness,
    ProximityRisks =
      if_else(
        ContactWithUnderInvestigationDate > today() - days(14) |
          is.na(ContactWithUnderInvestigationDate),
        ContactWithUnderCOVID19Investigation,
        0
      ) +
      if_else(
        ContactWithConfirmedDate > today() - days(14) |
          is.na(ContactWithConfirmedDate),
        ContactWithConfirmedCOVID19Patient,
        0
      ),
    NumberOfRisks = HealthRisks + ProximityRisks,
    Priority = case_when(
      (
        Tested == 1 &
          TestResults == "Positive" & ymd(TestDate) > today() - days(14)
      ) |
        (UnderInvestigation == 1 & 
           (ymd(DateUnderInvestigation) > today() - days(14) |
           is.na(DateUnderInvestigation))) |
        MayHaveCOVID19CDC == TRUE |
        ProximityRisks > 0 |
        HealthRisks > 1 ~ "High",
      Symptom2Chills +
        Symptom2SoreThroat +
        Symptom2Fever +
        Symptom2Headache +
        Symptom2LostTasteSmell +
        Symptom2MusclePain +
        Symptom2ShakingChills > 0 |
        NumberOfRisks > 0 ~ "Medium",
      TRUE ~ "Low"
    ), 
    Priority = factor(Priority, levels = c("High", "Medium", "Low"))
  )

```

Our Coordinated Entry process will use this metric to determine whether a client should be prioritized for immediate non-congregate housing based on their risks, symptoms, contact with others, and test results. This will be made available in our Prioritization report, which is used to help communities with moving households into permanent housing. High Priority would mean the household should quarantine immediately, as they either have the right mix of symptoms, a lot of risk factors, or other strong indicators that they have COVID-19.

```{r fig2, fig.width=7, fig.asp=.62}

plot_b <- risks %>%
  select(PersonalID, COVID19AssessmentDate, Priority) %>%
  group_by(COVID19AssessmentDate, Priority) %>%
  summarise(Clients = n()) %>%
  arrange(Priority)

plot_b %>%
  ggplot(aes(x = COVID19AssessmentDate, y = Clients,
             fill = Priority, label = Clients)) +
  scale_fill_brewer(palette = "GnBu", direction = -1) +
  geom_bar(stat = "identity") +
  theme_classic() +
  ggtitle("Priority for Immediate Housing Based on Symptoms and Risk Factors") +
  theme(legend.title=element_blank(),
        legend.position = "top",
        legend.key.height = unit(0.1, "cm"),
        legend.key.width = unit(0.3, "cm"))+
  labs(x = "Date of Assessment", y = "Clients Assessed")
```


