---
title: "How I Decided Which Providers to Use"
author: "Genelle Denzin"
date: "9/9/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(readxl)
library(formattable)
```

### Data Sources

I'm beginning with the HUD CSV Export. I will only need the following files: Enrollment, Exit, Organization, and Project. The following code imports the data and assigns each dataset to a variable.

```{r getting_csv_data}

Enrollment <-
  read_csv("data/Enrollment.csv",
           col_types =
             "nnnDcnnnlnDnnnDDDnnnncccnnDnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnTTnTn")

Exit <-
  read_csv("data/Exit.csv",
           col_types = "nnnDncncnnnnnnnnnnnnnnnnnnnnnnnnnDnnnnnnTTnTn")

Organization <- 
  read_csv("data/Organization.csv",
           col_types = "nccTTnTn")

Project <- 
  read_csv("data/Project.csv",
           col_types = "nnccDDnnnnnnnnTTnTn")

```

## Further Adjustments to the HUD CSV Export 

Due to anamolies with ServicePoint's HUD CSV Export and data elements not required by HUD, but that are necessary for this analysis, I had to modify the contents of the imported tables from the HUD CSV Export in a few ways.

1.  Over the past year or so I've found numerous errors in ServicePoint's HUD CSV Export. The one that affects this analysis is being adjusted for by importing the data from the custom reporting tool in SP. The following logic overwrites the null columns we get in Project.csv with the Provider addresses from our custom reporting tool in ServicePoint. 

2. In the ServicePoint export, the provider IDs of the Organizations come out tacked onto the end of the Organization names, so I have some logic there to remove that.

3. Since Project County is not a HUD-required data element, it also ADDS the County in which the Project is located to the address data.

```{r csv_adjustments}

provider_data <- read_xlsx("data/RMisc.xlsx",
                            sheet = 5,
                            range = cell_cols("A:N")) %>%
  mutate(OrganizationName = str_remove(OrganizationName, "\\(.*\\)"))

Project <- Project %>%
  select(-ProjectName,-ProjectCommonName) %>%
  left_join(., provider_data, by = "ProjectID")

rm(provider_data)

```

4.  Since "County in which the Client was Served" is not a HUD-required data element, the following logic ADDS that data to Enrollment.csv. It is collected at Entry.

```{r}
counties <- read_xlsx("data/RMisc.xlsx",
                      sheet = 2,
                      range = cell_cols("A:C"))

Enrollment <- left_join(Enrollment, counties, by = "EnrollmentID") 

rm(counties)
```

At this point, we have the data needed to complete the analysis.

## Finding the YHDP Projects to Include

### Prep

Here I am just setting up by assigning a Report Start and Report End and I copied a couple of functions I created for determining which projects were operating and which clients were served during the reporting period for use in this analysis. Also creating an object to make it easier to call the Counties in question into later logic.

```{r set_up_objects}
ReportStart <- "10012018"
ReportEnd <- "09302019"

operating_between <- function(table, start, end) {
  operating <-  if_else(
    is.na(table$OperatingStartDate) |
      ymd(table$OperatingStartDate) > mdy(end) |
      (!is.na(table$OperatingEndDate) &
         ymd(table$OperatingEndDate) < mdy(start)),
    FALSE,
    TRUE
  )
  operating
}

served_between <- function(table, start, end){
  served <- ymd(table$EntryDate) <= mdy(end) &
    (is.na(table$ExitDate) | ymd(table$ExitDate) > mdy(start))
  served
}

YHDP_Counties <- c("Athens", "Jackson", "Vinton", "Gallia", "Meigs")
```

Just getting a slimmed down version of the Project.csv and renaming the County field so it's not confused with the CountyServed field, related to Enrollments.

```{r figuring}
small_projects <- Project %>%
  select(
    ProjectID,
    ProjectName,
    OrganizationName,    
    OrganizationID,
    OperatingStartDate,
    OperatingEndDate,
    ProjectType,
    "ProviderCounty" = County,
  )
```

#### Filtering the Data

We don't have any PH - Housing w/ Services or Day Shelters, so I never include it in anything, but I would imagine other CoCs might want to include them. I'm excluding Services Only, because 1. we dont have any of this project type in these counties and 2. that project type isn't required for the LSA. I'm including Outreach because I am hoping it will start to be included in HUD reporting so that we are not always missing our unsheltered clients and I figure if it isn't needed, it can be ignored. I'm excluding Prevention because those are not included in the LSA proper.

I'm also limiting my results to those projects that were operational during the reporting period. (Using the Operating Start and End Dates.)

Finally, I want to filter down to the definite set of projects based on ProviderCounty, which comes from their address record.

```{r strict}
strictly_in_the_region <- small_projects %>%
  filter(ProjectType %in% c(1:4, 8:9, 13) &
           operating_between(., ReportStart, ReportEnd) &
           ProviderCounty %in% YHDP_Counties) %>%
    select(ProjectID,
         ProjectName,
         OrganizationName,
         ProjectType,
         ProviderCounty)
```

Now that we have a core set of projects that will be included, I need to also gather the projects in the BoS that served households inside the YHDP counties in the reporting period.

```{r served_in_region}
projects_serving_in_region <-
  Enrollment[c("PersonalID",
               "EnrollmentID",
               "EntryDate",
               "ProjectID",
               "CountyServed")] %>%
  left_join(Exit[c("PersonalID", 
                   "EnrollmentID", 
                   "ExitDate")], by = c("PersonalID", "EnrollmentID")) %>%
  left_join(small_projects, by = "ProjectID") %>%
  filter(ProjectType %in% c(1:4, 8:9, 13) &
           served_between(., ReportStart, ReportEnd) &
           operating_between(., ReportStart, ReportEnd) &
           CountyServed %in% YHDP_Counties) %>%
  select(ProjectID,
         ProjectName,
         OrganizationName,
         ProjectType,
         ProviderCounty) %>%
  unique()
```

There are clearly some projects that exist outside the YHDP region that serve households in the region. So in order to wind up with a final list of projects to select for the LSA reporting group, we would add those to the projects that actually exist within the boundaries of the YHDP region.

```{r final}
final_list <- strictly_in_the_region %>%
  full_join(
    projects_serving_in_region,
    by = c(
      "ProjectID",
      "ProjectName",
      "OrganizationName",
      "ProjectType",
      "ProviderCounty"
    )
  ) %>%
  select(
    "Project ID" = ProjectID,
    "Project Type" = ProjectType,
    "Project" = ProjectName,
    "Organization" = OrganizationName,
    "Project County" = ProviderCounty
  )

formattable(final_list)
```



