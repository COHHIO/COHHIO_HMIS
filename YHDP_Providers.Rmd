---
title: "How I Decided Which Providers to Use"
author: "Genelle Denzin"
date: "9/9/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(readxl)
```

Need to know which projects are maybe outside the region but that serve clients inside the region.
Filter projects based on which ones were operational during the date range, keep it to ES, TH, PSH, RRH, HP, OUT, and SH, but exclude the Unsheltered provider. Do not filter on funding source.
Run quick Bed/Unit Utilization report on each provider to look for weirdnesses (these are available publicly here: https://ohiobalanceofstatecoc.shinyapps.io/Rminor/)
Found a YHDP project with zero clients in HMIS. Including them anyway, as it serves to show capacity.
Found RHP TLP project with zero clients.
Our Vinton TH project has super low utilization. Keeping them in.
Our Vinton TH YHDP project has zero clients. So does the RHY BCPes and BCPp.
There’s “Lawrence Gallia” SSVF RRH and SSVF HP projects. Including those.

### Data Sources

I'm beginning with the HUD CSV Export. I ran the Export on ALL providers that have been active in the past two years. I will only need the following files: Enrollment, Exit, Geography, Inventory, Organization, Project, ProjectCoC.

```{r getting_csv_data}

Enrollment <-
  read_csv("data/Enrollment.csv",
           col_types =
             "nnnDcnnnlnDnnnDDDnnnncccnnDnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnTTnTn")

Exit <-
  read_csv("data/Exit.csv",
           col_types = "nnnDncncnnnnnnnnnnnnnnnnnnnnnnnnnDnnnnnnTTnTn")

Geography <- 
  read_csv("data/Geography.csv",
           col_types = "nncDnnccccnTTnTn")

Inventory <- 
  read_csv("data/Inventory.csv",
           col_types = "nncnnnnnnnnDDnTTDnTn")
Organization <- 
  read_csv("data/Organization.csv",
           col_types = "nccTTnTn")
Project <- 
  read_csv("data/Project.csv",
           col_types = "nnccDDnnnnnnnnTTnTn")
ProjectCoC <- 
  read_csv("data/ProjectCoC.csv",
           col_types = "nncTTnTn")
```

## Further Adjustments to WS's HUD CSV Export

Over the past year or so I've found numerous errors in WS's HUD CSV Export. The ones that affect this analysis are being adjusted for by importing the data from their custom reporting tool. The following logic is because the Youth Beds do not show in Inventory.csv and the Provider addresses do not show in Project.csv.

```{r csv_adjustments}

# Youth Beds not coming through correctly (vendor issue) -----------------
youth_beds <- read_xlsx("data/RMisc.xlsx",
                       sheet = 8,
                       range = cell_cols("A:C"))
Inventory <- left_join(Inventory, youth_beds, by = "InventoryID") %>%
  select(1, ProjectID = 2, 3:9, YouthBedInventory = 22, 11:20) 

rm(youth_beds)

# Provider Addresses also not coming out in Export (vendor issue) ---------
provider_data <- read_xlsx("data/RMisc.xlsx",
                            sheet = 5,
                            range = cell_cols("A:M")) %>%
  mutate(OrganizationName = str_remove(OrganizationName, "\\(.*\\)"))

# temporary, because you should add this to the ART report:
provider_county <- read_csv("data/providercounties.csv", col_types = "nc")

```

The following logic ADDS data regarding the County each client was served in at Entry into a project, that is not necessarily collected by other CoCs.

```{r}
counties <- read_xlsx("data/RMisc.xlsx",
                      sheet = 2,
                      range = cell_cols("A:C"))

Enrollment <- left_join(Enrollment, counties, by = "EnrollmentID") 

rm(counties)
```

The following logic overwrites the Project names because some of our Project names go over 50 characters (mostly because we precede all our project names with the County the project is located in).

```{r}
Project <- Project %>%
  select(-ProjectName,-ProjectCommonName) %>%
  left_join(., provider_data, by = "ProjectID") %>%
  left_join(., provider_county, by = "ProjectID")

rm(provider_data, provider_county)
```

## Finding the YHDP Projects to Include

Here I am just setting up by assigning a Report Start and Report End and I copied a function I created for determining which projects were operating during the reporting period.

```{r set_up_objects, echo=FALSE}
ReportStart <- "10012018"
ReportEnd <- "09302019"

operating_between <- function(table, start, end) {
  operating <-  if_else(
    is.na(table$OperatingStartDate) |
      ymd(table$OperatingStartDate) > mdy(end) |
      (!is.na(table$OperatingEndDate) &
         ymd(table$OperatingEndDate) < mdy(start)),
    FALSE,
    TRUE
  )
  operating
}

YHDP_Counties <- c("Athens", "Jackson", "Vinton", "Gallia", "Meigs")
```

I am wild-guessing about what Project Types to include. We don't have any PH - Housing w/ Services or Day Shelters, so I never include it in anything, but I would imagine other CoCs might want to include them. I'm excluding Services Only, because 1. we dont have any of this project type in these counties and 2. that project type doesn't require homeless verification, so I'm thinking it's outside the scope of what we're doing. I'm including Outreach because I am hoping it will start to be included in HUD reporting so that we are not always missing our unsheltered clients. And I figure if it isn't needed, it can be ignored. I'm excluding Prevention because that project type doesn't require homeless verification, so I'm thinking it's outside the scope of what we're doing.

I'm also limiting my results to those projects that were operational during the reporting period.

```{r figuring}
small_projects <- Project %>%
  filter(ProjectType %in% c(1:4, 8:9, 13) &
           operating_between(., ReportStart, ReportEnd)) %>% 
  select(
    ProjectID,
    ProjectName,
    OrganizationName,    
    OrganizationID,
    OperatingStartDate,
    OperatingEndDate,
    ProjectType,
    "ProviderCounty" = County,
  ) %>% unique()
```

At this point I have cast a wide net and these projects are all over the Balance of State. I want to filter down to the definite set of projects:

```{r strict}
strictly_in_the_region <- small_projects %>%
  filter(ProviderCounty %in% YHDP_Counties)
```

Now that we have a core set of projects that will be included, I need to also gather the projects in the BoS who served households inside the set of counties.





