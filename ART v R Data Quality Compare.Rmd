---
title: "ART v R Data Quality"
author: "Genelle Denzin"
date: "8/12/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
library(tidyverse)
library(janitor)
library(readxl)
library(gt)
```

## What's in ART?

For the past few years, I have been exporting the results of our two custom Data Quality reports in ART to Qlik Sense Cloud for monthly reviews of the projects that need to be followed up with. Those reports come from my Favorites > Data Quality > Data Quality Monitoring folder. The two reports are named Data Quality 1- for export and Data Quality 2- for export. In the next code chunk, I'm pulling in the results of these two reports so I can compare these results to the ones in R minor.

Following is the first seven rows of the object with all the ART-exported Data Quality data.

```{r ART_DQ}
hhs <- read_xls("data/Data Quality 1- for export.xls",
                sheet = 1, 
                range = cell_cols("A:D")) %>%
  select(1, 2, 4)

colnames(hhs) <- c("Issue", "Provider", "ClientID")

missing <- read_xls("data/Data Quality 1- for export.xls",
                sheet = 2, 
                range = cell_cols("A:C"))

colnames(missing) <- c("Issue", "Provider", "ClientID")

missingsubs <- read_xls("data/Data Quality 1- for export.xls",
                sheet = 3, 
                range = cell_cols("A:C"))

colnames(missingsubs) <- c("Issue", "Provider", "ClientID")

ART_DQ1 <- rbind(hhs, missing, missingsubs)

rm(hhs, missing, missingsubs)

dq2 <- rbind(
  read_xls("data/Data Quality 2- for export.xls",
           sheet = 1, 
           range = cell_cols("A:C")),
  read_xls("data/Data Quality 2- for export.xls",
           sheet = 2, 
           range = cell_cols("A:C")),
  read_xls("data/Data Quality 2- for export.xls",
           sheet = 3, 
           range = cell_cols("A:C")),
  read_xls("data/Data Quality 2- for export.xls",
           sheet = 4, 
           range = cell_cols("A:C")),
  read_xls("data/Data Quality 2- for export.xls",
           sheet = 5, 
           range = cell_cols("A:C")),
  read_xls("data/Data Quality 2- for export.xls",
           sheet = 6, 
           range = cell_cols("A:C")),
  read_xls("data/Data Quality 2- for export.xls",
           sheet = 7, 
           range = cell_cols("A:C")),
  read_xls("data/Data Quality 2- for export.xls",
           sheet = 8, 
           range = cell_cols("A:C"))
)

colnames(dq2) <-c("Issue", "Provider", "ClientID")

ART_DQ <- rbind(dq2, ART_DQ1)

rm(ART_DQ1, dq2)

gt(head(ART_DQ))
```

## What's in R?

Let's get the same data, but using the logic in the 04_DataQuality.R script (which is then saved to an image used in both Shiny apps.)

```{r R_DQ, echo=TRUE}
load("images/Data_Quality.RData")

R_DQ <- DataQualityHMIS %>% select(Issue, ProjectName, PersonalID)
```

## What ClientIDs Are Not Showing in R that are in ART?

A thing to note about the different reports is hardly any of the Issues are worded exactly in the same way so I'm not able to compare the datasets in that way.

In addition to pulling the ClientIDs, I need to know which errors those clients have on the ART report so I can have a place to start from when I go to look at the Data Quality script.

The following will give me some issues and example ClientIDs to start looking into. These are Clients and Issues found on the ART report that Rm is NOT finding.

```{r ART_has_it_Issues}
R_ClientIDs <- as.data.frame(R_DQ$PersonalID %>% unique())
colnames(R_ClientIDs) <- "ClientID"

ART_ClientIDs <- as.data.frame(ART_DQ$ClientID %>% unique())
colnames(ART_ClientIDs) <- "ClientID"

missingFromR <- anti_join(ART_ClientIDs, R_ClientIDs, by = "ClientID")

missingFromRIssues <- missingFromR %>% left_join(ART_DQ, by = "ClientID") %>%
  group_by(Issue) %>% 
  summarise(Example = min(ClientID)) %>%
  filter(!is.na(Example))

gt(missingFromRIssues)
```


The Children Only Household was a RHY project. I am accounting for RHY projects when I am looking at Children-Only Households in R minor. (R minor is ok.)

The Disability subs Not Matching is to do with the ticket I have in with WS about the subassessments not paying attention to the Report Start and Report End Dates. (Need to retest once that ticket is sorted out.)

Future Entry Exit: For PSHs prior to 10/2016, Future Entry Exits were a common thing because the Entry Date was the Move In Date back then so users would often enter their clients into HMIS prior to the client moving in. (Rm is ok.)

HoHs Entering PH without SPDATs: In Rm, we're only looking at 1/1/2019 forward. (Rm is ok)

HoHs In Shelter w/o SPDAT: In Rm, we're only looking at 1/1/2019 forward AND we're only looking at Stayers because once they've left, there's no way to really "fix" it and then users start making stuff up. (Rm is ok)

Incorrect PATH Contact Date: This is not coded in Rm yet! (ART is correct)

Missing Destination: Also not coded in Rm yet! (ART is correct)

Missing Rel to HoH: This is just because there is a gap in reporting dates. That tells me all the Clients in ART for Missing HoH are also in Rm. (Both are correct!)

Missing NCBs at Entry: This client has a "No" at Entry, not sure why the ART report is flagging this one? (Rm is correct) At least in Rm, the logic is only looking at the yes/no.

Missing NCBs at Exit: This client has a "No" at Exit, not sure why the ART report is flagging this one? (Rm is correct) The Rm logic is only looking at the yes/no.

Missing or Incorrect SSN: Client 4216 is our demo client on the live site. The COHHIO providers are not being pulled into the Rm providers to be checked for DQ so this client is not showing in Rm. (Rm is correct)

The next four are to do with PATH Data Quality issues. These are not yet coded in Rm. (ART is correct.)

Missing UDEs: I don't know why this is pulling into the ART report. All seems fine when I look at the client record AND when I actually run the provider-level ART report. (!) (Rm is correct.)

Too many HoHs: Dataset lag time issue. (Both are correct.)

Non-HoHs with Services or Referrals: This client is definitely a non-HoH who has some RRH services on her. The services were created on every hh member. As stated in the comments in the Data Quality script, not all the Services or Referrals are coming in. Once I can get the RMisc export moved to ReportWriter or whatever, these issues will be more reliable in Rm. (ART is correct.)

Old Outstanding Referrals: same as above: incomplete Services and Referral data coming into Rm.

Questionable Housing Data (or "Check Eligibility"): Rm is only looking at hhs who entered PSH more recently than 2016 since rules were less clear back then.

Side Door: Rm is only checking this from 1/1/2019 forward. (I think Rm is ok)

Any issues not named are to do with Services or Referrals, which needs re-examining at the import level.

## What ClientIDs are showing in R that are not showing in ART?

```{r R_has_it_issues}
missingFromART <- anti_join(R_ClientIDs, ART_ClientIDs, by = "ClientID")

missingFromARTIssues <- missingFromART %>% 
  left_join(R_DQ, by = c("ClientID" = "PersonalID")) %>%
  group_by(Issue) %>% summarise(Example = min(ClientID))

gt(missingFromARTIssues)
```


Access Point with Entry Exits: not looking at this in ART. (Rm is correct.)

Check Eligibility: ART report is ignoring HOPWA providers. (ART is correct.)

Check Veteran Status for Accuracy: The provider-level ART report does show this. (Both are correct.)

Children Only Household: I checked the ART report but not sure why it didn't find these. They're clear cut cases. (Rm is correct.)

Client w No Disability Receiving SSI/SSDI: The provider-level ART report is catching this. Probably not pulling into the export because the Provider is not Operational currently. (Rm is correct)

DKR Ethnicity: the provider-level DQ report does return this one, not sure why the export isn't. (Rm is correct)

DKR Living Situation: This is coded totally differently in ART. The ART report breaks down each data element whereas Rm takes "Living Situation" as a whole thing that depends on multiple data elements. In this case, the client's # of months homeless in the past 3 years is Client doesn't know. The ART Report is not picking this up at all, not sure why. (Rm is correct, but could use some attention in the way it's presented.)

DKR/Approx DOB: This is an Approximate DOB. The ART report is flagging Approximate DOB as missing. The APR flags Approximate as an "Issue" so we're thinking it makes more sense to flag this here as a Warning not an Error. So the way Rm is doing it makes the most sense, it's just lumping the DKR in with the "Issue". (Rm is correct.)

DKR Race: Actually shows on the provider-level ART report, so the reports are in agreement. (Both are correct.)

Duplicate EEs: No idea why this isn't showing in the ART report? Super obvious. The ART report is using the 0640 report logic and it's really hard to decipher. (Rm is correct.)

Missing Health Insurance at Entry: This is on the Union Senior Assistance HP project which we are excluding from the Data Quality Export. (Rm is correct.)

Income Missing at Entry & Exit: This is on the Union Senior Assistance HP project which we are excluding from the Data Quality Export. (Rm is correct.)

HoHs in ES or TH for 8+ days without SPDAT Score: The client does have scores. Found an error in Rm, corrected it, yay. (Both are now correct.)

Incomplete Living Situation: (ART is correct.) Review the Glossary, page 24, for all the rules about how that should be calculated.

Incomplete or DKR Name: The example ClientID is anonymous. Not sure why the ART report wouldn't pull this. (Rm is correct.)

Incorrect DOB or Entry Date: (Rm is correct.)

Incorrect EE Type: not finished coding this in Rm. (ART is correct.)

Incorrect Move In Date: (Rm is correct.) In this case, the Move-In Date should have been blanked out when they entered the RRH.

Incorrect SSN: This SSN starts with a zero. (Rm is correct.)

The County fields: ART isn't picking this up because the County fields weren't required until we added them to the assessment. We may want to discuss just leaving Rm the way it is anyway so maybe people will go back and fill in the Counties on old clients? (Both are correct, but ART is correcter.)

Missing DOB DQ: In ART, it's not looking at DOB Data Quality. (Rm is correct.)

Missing Disability Subs: waiting on WS to fix their export.

Missing Disabling Condition: This is on the Union Senior Assistance HP project which we are excluding from the Data Quality Export. (Rm is correct, but we should exclude them in Rm also.)

Missing Name Data Quality: The ART report isn't picking this up because it was excluding old clients. I feel like we should start showing these, but would need to see more info to know how many clients are actually affected by this first. (Both are correct, but ART is correcter.)

Missing SSN: The client's SSN field is blank, but their SSN Data Quality field is "Client doesn't know" so really this should be coming out as DKR SSN, not Missing SSN! (Fixed this in Rm. Rm is correct.)

No HoH: This is on the Union Senior Assistance HP project which we are excluding from the Data Quality Export. (Rm is correct, but we should exclude them in Rm also.)

NCBs Missing at Exit: This is on the Union Senior Assistance HP project which we are excluding from the Data Quality Export. (Rm is correct.)


Overlapping EEs: Not calculated in the ART report. (Rm is correct.)

Service Transaction on a Non-HoH: (Rm is correct.) This particular error is written differently for SSVF projects in the ART report (but that doesn't explain why this client's error did not show on the ART provider-level Data Quality report.) The way it should be is for SSVF projects, this definitely needs to be corrected since forever ago. For non-SSVF projects, it only needs to be corrected back to February 2018, but it's not super important to correct it. It may be a good idea to count this as an Error for SSVF projects but count it as a Warning for non-SSVF projects. (Rm is correct, but could use some nuance.)

Too Many Heads of Household: This is waiting on resolution on WS ticket# 858797.

## List of Things to Solve Prior to Killing the ART Reports

1. WS Ticket #837944 needs to be resolved, then retest.
2. All the PATH-related Data Quality issues need to be added.
3. Missing Destination needs to be added.
4. Figure out why the NCB at Entry and NCB at Exit is showing on the ART report (to be sure there's not something I'm missing)
5. Redo the way Services and Referrals are imported. The HUD CSV is not enough. :(
6. Rm should ignore HOPWA projects and EEs.
7. Maybe break out Missing and DKR Living Situation into more granular errors.
8. Correct Incomplete Living Situation, something's wrong. Sample ClientID = 8155.
9. Code the Incorrect EE Type thoroughly.
10. Figure out if we want to continue to let the custom County fields data quality go on old clients. (Rm is counting them as missing.)
11. Exclude the Union Senior Assistance HP project from Rm.
12. For Non-HoHs with Services/Referrals, SSVF projects should be showing this as an Error, whereas non-SSVF projects should be showing it as a warning, and only back to Feb of 2018.
13. WS Ticket #858797 needs to be resolved, then retest.


